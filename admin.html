<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Dashboard | Online Academy Guru</title>
<style>
  body { font-family: "Segoe UI", Arial, sans-serif; background: #f8fafc; margin: 0; display: flex; min-height: 100vh; }

  /* Sidebar */
  .sidebar { width: 260px; background: #2a3d66; color: white; padding: 18px 12px; display: flex; flex-direction: column; }
  .brand { text-align:center; margin-bottom:14px; font-weight:700; letter-spacing:0.6px; text-transform:uppercase;}
  .main-tab {
    width: 100%;
    padding: 10px 12px;
    margin: 6px 0;
    border-radius: 8px;
    text-align: left;
    cursor: pointer;
    background: rgba(255,255,255,0.04);
    transition: background .18s;
    display:flex;
    align-items:center;
    gap:8px;
  }
  .main-tab.active { background: white; color:#2a3d66; font-weight:700; }
  .main-tab:hover { background: rgba(255,255,255,0.08); }

  .subtabs { margin-left: 12px; margin-top:4px; margin-bottom:8px; display:flex; flex-direction:column; gap:6px; }
  .subtab {
    width: calc(100% - 12px);
    padding: 6px 10px;
    border-radius: 6px;
    background: rgba(255,255,255,0.06);
    cursor:pointer;
    font-size:0.86rem;
    color:#e7eefc;
    text-align:left;
  }
  .subtab.active { background: white; color:#2a3d66; font-weight:600; }

  /* Main content */
  .main-content { flex:1; padding:18px; }
  .top-bar { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:12px; flex-wrap:wrap; }
  .search-box input { padding:8px 12px; border-radius:6px; border:1px solid #ccc; width:360px; font-size:0.95rem; }
  .logout-btn { background:#c53030; color:#fff; border:none; padding:7px 12px; border-radius:6px; cursor:pointer; }

  table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
  th, td { padding:8px 10px; border-bottom:1px solid #e6e9ee; text-align:left; font-size:0.9rem; vertical-align:top; }
  th { background:#2a3d66; color:#fff; text-transform:uppercase; font-size:0.78rem; }
  .view-btn { background:#2a3d66; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
  select.status { padding:6px 12px; border-radius:6px; border:1px solid #d1d5db; }

  .status-pending { color:#d97706; font-weight:600; }
  .status-inprogress { color:#2563eb; font-weight:600; }
  .status-completed { color:#16a34a; font-weight:600; }
  .status-replied { color:#7c3aed; font-weight:600; }

  /* Course form */
  #courseForm { background:#fff; padding:14px; border-radius:8px; max-width:820px; box-shadow:0 2px 6px rgba(0,0,0,0.06); }
  #courseForm input,#courseForm textarea,#courseForm select { width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #d1d5db; box-sizing:border-box; }
  #courseForm button { background:#2a3d66; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }

  /* Modal & toast */
  .modal { display:none; position:fixed; z-index:10000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.45); align-items:center; justify-content:center; }
  .modal-content { background:#fff; padding:18px; border-radius:10px; width:90%; max-width:760px; box-shadow:0 8px 30px rgba(0,0,0,0.15); }
  .close-btn { background:#c53030; color:#fff; border:none; padding:6px 10px; border-radius:6px; float:right; cursor:pointer; }
  pre { white-space:pre-wrap; word-break:break-word; margin:0; font-family:inherit; font-size:0.95rem; }

  .toast { visibility:hidden; min-width:220px; background:#16a34a; color:#fff; text-align:center; border-radius:8px; padding:12px; position:fixed; z-index:9999; left:50%; bottom:30px; transform:translateX(-50%); opacity:0; transition:opacity .35s, bottom .35s; }
  .toast.show { visibility:visible; opacity:1; bottom:50px; }

  @media (max-width:900px){ .sidebar{display:none;} .search-box input{width:100%;} body{padding-top:60px;} }
</style>
</head>
<body>
  <div class="sidebar">
    <div class="brand">Online Academy Guru</div>

    <!-- Free Trial -->
    <div class="main-tab" data-tab="trial">📋 Free Trial Form Requests</div>
    <div class="subtabs" id="trial-subtabs">
      <div class="subtab" data-parent="trial" data-status="Pending">Pending</div>
      <div class="subtab" data-parent="trial" data-status="In Progress">In Progress</div>
      <div class="subtab" data-parent="trial" data-status="Replied">Replied</div>
      <div class="subtab" data-parent="trial" data-status="Completed">Completed</div>
    </div>

    <!-- Contact -->
    <div class="main-tab" data-tab="contact">📬 Contact Form Requests</div>
    <div class="subtabs" id="contact-subtabs">
      <div class="subtab" data-parent="contact" data-status="Pending">Pending</div>
      <div class="subtab" data-parent="contact" data-status="In Progress">In Progress</div>
      <div class="subtab" data-parent="contact" data-status="Replied">Replied</div>
      <div class="subtab" data-parent="contact" data-status="Completed">Completed</div>
    </div>

    <!-- Manage Courses -->
    <div class="main-tab" data-tab="courses">📚 Manage Courses</div>
  </div>

  <div class="main-content">
    <div class="top-bar">
      <div class="search-box"><input id="searchInput" placeholder="🔍 Search by name, email, mobile, or ID..." /></div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- Trial -->
    <section id="trialSection">
      <h3>Free Trial Form Requests</h3>
      <table id="trialTable">
        <thead><tr><th>Request ID</th><th>Student</th><th>Parent</th><th>Mobile</th><th>Class</th><th>Subject</th><th>View</th><th>Status</th><th>Submitted</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Contact -->
    <section id="contactSection" style="display:none;">
      <h3>Contact Form Requests</h3>
      <table id="contactTable">
        <thead><tr><th>Request ID</th><th>Role</th><th>Name</th><th>Email</th><th>Mobile</th><th>City & State</th><th>View</th><th>Status</th><th>Submitted</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Courses -->
    <section id="coursesSection" style="display:none;">
      <h3>Add / Manage Courses</h3>
      <form id="courseForm">
        <select name="Class" required>
          <option value="">Select Class</option>
          <option>Pre</option><option>Nursery</option><option>KG</option>
          <option>Class 1</option><option>Class 2</option><option>Class 3</option>
          <option>Class 4</option><option>Class 5</option><option>Class 6</option>
          <option>Class 7</option><option>Class 8</option><option>Class 9</option>
          <option>Class 10</option><option>Class 11</option><option>Class 12</option>
        </select>
        <input name="Subject" placeholder="Subject (e.g. Mathematics)" required />
        <input name="Title" placeholder="Course Title" required />
        <textarea name="Description" rows="3" placeholder="Short description (optional)"></textarea>
        <input name="PDF_URL" placeholder="Paste Google Drive link (shareable)" required />
        <div style="text-align:right"><button type="submit">Add Course</button></div>
        <div id="courseMsg" style="margin-top:10px;color:green;"></div>
      </form>

      <div style="margin-top:18px;">
        <h4>Existing Courses (Preview)</h4>
        <div id="coursesPreview" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;"></div>
      </div>
    </section>

    <div id="toast" class="toast">Action complete</div>
  </div>

  <div id="messageModal" class="modal"><div class="modal-content"><button class="close-btn" onclick="closeModal()">Close</button><h3>Request Details</h3><pre id="modalMessage"></pre></div></div>

<script>
const TRIAL_SCRIPT_URL="https://script.google.com/macros/s/AKfycbxUMI6Qxws_LzicfqWfV6Ky2dq6Zz9doel3yw1JY7FHouqAoop_pIzN8eyasRBgs28/exec";
const CONTACT_SCRIPT_URL="https://script.google.com/macros/s/AKfycbx38g7GpXiVyby5LyK8F_xIP3V9aaB8jqV3lI8F9QACIVSWd2RIuaiqvMix5_Egbiue/exec";
const COURSE_SCRIPT_URL="https://script.google.com/macros/s/AKfycbyz7BhLYel26C8yedQd1HexC2SPbVfDyzAH14uZ3ljlM9uC5UElEVla8m91iB7N0oQU/exec";
const ADMIN_PASSWORD="Admin@123";

let trialRequests=[],contactRequests=[],filteredRequests=[],currentSection='trial';

(function authenticate(){
  const pass=sessionStorage.getItem("adminAuth")||prompt("Enter admin password:");
  if(pass!==ADMIN_PASSWORD){alert("Access Denied");location.href="index.html";return;}
  sessionStorage.setItem("adminAuth",ADMIN_PASSWORD);
  init();
})();
function logout(){sessionStorage.removeItem("adminAuth");location.href="index.html";}

function init(){bindSidebar();bindSubtabs();bindSearch();bindCourseForm();loadTrialRequests();loadContactRequests();loadCoursesPreview();}

/* Sidebar */
function bindSidebar(){
  document.querySelectorAll('.main-tab').forEach(t=>{
    t.addEventListener('click',()=>{
      document.querySelectorAll('.main-tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const tab=t.dataset.tab;switchSection(tab);
      // deactivate all subtabs when main tab switched
      document.querySelectorAll('.subtab').forEach(x=>x.classList.remove('active'));
    });
  });
}

/* Section switch */
function switchSection(section){
  currentSection=section;
  document.getElementById('trialSection').style.display=(section==='trial')?'block':'none';
  document.getElementById('contactSection').style.display=(section==='contact')?'block':'none';
  document.getElementById('coursesSection').style.display=(section==='courses')?'block':'none';
  if (!filteredRequests.length) filteredRequests = [];
  displayActiveRequests();
}

/* Subtabs */
function bindSubtabs(){
  document.querySelectorAll('.subtab').forEach(s=>{
    s.addEventListener('click',()=>{
      const parent=s.dataset.parent;
      // Only deactivate subtabs of same parent
      document.querySelectorAll(`.subtab[data-parent="${parent}"]`).forEach(x=>x.classList.remove('active'));
      s.classList.add('active');
      const status=s.dataset.status;
      let dataset=parent==='contact'?contactRequests:trialRequests;
filteredRequests = dataset.filter(r => {
  const val = (r['Status'] || 'Pending').trim().toLowerCase();
  const filter = status.trim().toLowerCase();
  return val === filter;
});
      switchSection(parent);
      displayActiveRequests();
    });
  });
}

/* Search */
function bindSearch(){
  const input=document.getElementById('searchInput');
  input.addEventListener('input',()=>{
    const q=input.value.trim().toLowerCase();
    if(!q){displayActiveRequests();return;}
    const active=(currentSection==='contact')?(filteredRequests.length?filteredRequests:contactRequests):(filteredRequests.length?filteredRequests:trialRequests);
    const result=active.filter(r=>{
      const fields=[r['Request ID']||'',r['Name']||r['Student Name']||'',r['Parent Name']||'',r['Email']||'',r['Mobile']||''].join(' ').toLowerCase();
      return fields.includes(q);
    });
    (currentSection==='contact')?displayContactRequests(result):displayTrialRequests(result);
  });
}

/* Helpers */
function displayActiveRequests(){
  if(currentSection==='contact')displayContactRequests(filteredRequests.length?filteredRequests:contactRequests);
  else displayTrialRequests(filteredRequests.length?filteredRequests:trialRequests);
}

/* Load data */
async function loadTrialRequests(){try{const r=await fetch(TRIAL_SCRIPT_URL);const d=await r.json();trialRequests=Array.isArray(d)?d.map(o=>{const x={};for(let k in o)x[k.trim()]=o[k];return x;}):[];displayTrialRequests(trialRequests);}catch(e){console.error(e);}}
async function loadContactRequests(){try{const r=await fetch(CONTACT_SCRIPT_URL);const d=await r.json();contactRequests=Array.isArray(d)?d.map(o=>{const x={};for(let k in o)x[k.trim()]=o[k];return x;}):[];displayContactRequests(contactRequests);}catch(e){console.error(e);}}

/* Display tables */
function displayTrialRequests(list){const tb=document.querySelector('#trialTable tbody');tb.innerHTML='';(list||[]).slice().reverse().forEach(r=>{const id=r['Request ID']||'',st=r['Student Name']||'-',pa=r['Parent Name']||'-',m=r['Mobile']||'-',cl=r['Class']||'-',su=r['Subject']||'-',ts=r['Timestamp']||'',status=r['Status']||'Pending',css=getStatusClass(status);const tr=document.createElement('tr');tr.innerHTML=`<td>${id}</td><td>${st}</td><td>${pa}</td><td>${m}</td><td>${cl}</td><td>${su}</td><td><button class="view-btn">View</button></td><td><select class="status ${css}"><option ${status==="Pending"?"selected":""}>Pending</option><option ${status==="In Progress"?"selected":""}>In Progress</option><option ${status==="Replied"?"selected":""}>Replied</option><option ${status==="Completed"?"selected":""}>Completed</option></select></td><td>${ts}</td>`;tb.appendChild(tr);tr.querySelector('.view-btn').addEventListener('click',()=>openRequestModal(r,'trial'));const sel=tr.querySelector('select');sel.dataset.old=status;sel.addEventListener('change',()=>handleStatusChange(id,sel,TRIAL_SCRIPT_URL));});}

function displayContactRequests(list){const tb=document.querySelector('#contactTable tbody');tb.innerHTML='';(list||[]).slice().reverse().forEach(r=>{const id=r['Request ID']||'',ro=r['Role']||'',na=r['Name']||'-',em=r['Email']||'-',mo=r['Mobile']||'-',ci=r['City & State']||'',ts=r['Timestamp']||'',status=r['Status']||'Pending',css=getStatusClass(status);const tr=document.createElement('tr');tr.innerHTML=`<td>${id}</td><td>${ro}</td><td>${na}</td><td>${em}</td><td>${mo}</td><td>${ci}</td><td><button class="view-btn">View</button></td><td><select class="status ${css}"><option ${status==="Pending"?"selected":""}>Pending</option><option ${status==="In Progress"?"selected":""}>In Progress</option><option ${status==="Replied"?"selected":""}>Replied</option><option ${status==="Completed"?"selected":""}>Completed</option></select></td><td>${ts}</td>`;tb.appendChild(tr);tr.querySelector('.view-btn').addEventListener('click',()=>openRequestModal(r,'contact'));const sel=tr.querySelector('select');sel.dataset.old=status;sel.addEventListener('change',()=>handleStatusChange(id,sel,CONTACT_SCRIPT_URL));});}

/* Status classes */
function getStatusClass(s){if(s==="Pending")return'status-pending';if(s==="In Progress")return'status-inprogress';if(s==="Completed")return'status-completed';if(s==="Replied")return'status-replied';return'';}

/* Modal */
function openRequestModal(r,t){let lines=[];for(let k in r){lines.push(k+": "+r[k]);}document.getElementById('modalMessage').innerText=lines.join('\n');document.getElementById('messageModal').style.display='flex';}
function closeModal(){document.getElementById('messageModal').style.display='none';}

/* Status change */
async function handleStatusChange(id,sel,url){const old=sel.dataset.old||sel.value;const val=sel.value;const remark=prompt(`Enter remark for "${val}" status:`);if(!remark){sel.value=old;return;}sel.className='status '+getStatusClass(val);try{const r=await fetch(`${url}?update=${encodeURIComponent(id)}&status=${encodeURIComponent(val)}&remark=${encodeURIComponent(remark)}`);if(r.ok){showToast("✅ Updated");updateLocalRecordStatus(id,val,remark);}else{sel.value=old;showToast("❌ Error");}}catch(e){sel.value=old;showToast("❌ Error");}}
function updateLocalRecordStatus(id,s,rem){[trialRequests,contactRequests].forEach(a=>a.forEach(r=>{if((r['Request ID']||'')==id){r['Status']=s;r['Admin Remark']=rem;}}));displayActiveRequests();}

/* Toast */
function showToast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2400);}

/* Courses */
async function loadCoursesPreview(){try{const r=await fetch(COURSE_SCRIPT_URL);const d=await r.json();const list=Array.isArray(d)?d.map(o=>{const x={};for(let k in o)x[k.trim()]=o[k];return x;}):[];renderCoursesPreview(list);}catch(e){console.error(e);}}
function renderCoursesPreview(l){const box=document.getElementById('coursesPreview');box.innerHTML='';l.slice().reverse().forEach(c=>{const card=document.createElement('div');card.style.background='#fff';card.style.padding='10px';card.style.borderRadius='8px';card.style.boxShadow='0 1px 4px rgba(0,0,0,0.06)';card.innerHTML=`<strong style="color:#2a3d66">${c.Title||'-'}</strong><div style="font-size:0.85rem;color:#444;margin-top:6px">${c.Class||'-'} • ${c.Subject||'-'}</div><div style="margin-top:8px"><a href="${c.PDF_URL||'#'}" target="_blank" style="color:#007bff">Open PDF</a></div>`;box.appendChild(card);});}
function bindCourseForm(){const f=document.getElementById('courseForm'),m=document.getElementById('courseMsg');f.addEventListener('submit',async e=>{e.preventDefault();m.textContent='';const fd=new FormData(f);try{const r=await fetch(COURSE_SCRIPT_URL,{method:'POST',body:fd});const j=await r.json().catch(()=>({}));if(r.ok&&(j.result==="success"||j.result===undefined)){m.style.color='green';m.textContent='✅ Course added.';f.reset();setTimeout(loadCoursesPreview,900);}else{m.style.color='red';m.textContent='❌ Error adding course.';}}catch(e){m.style.color='red';m.textContent='❌ Error adding course.';}});}
</script>
</body>
</html>

