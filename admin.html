<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard | Online Academy Guru</title>
<style>
  body {
    font-family: "Segoe UI", Arial, sans-serif;
    background: #f8fafc;
    margin: 0;
    display: flex;
    min-height: 100vh;
  }

  /* Sidebar */
  .sidebar {
    width: 220px;
    background: #2a3d66;
    color: white;
    padding: 20px 0;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .sidebar h2 {
    font-size: 0.8rem;
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .tab {
    width: 80%;
    padding: 10px;
    margin: 5px 0;
    border-radius: 6px;
    text-align: center;
    cursor: pointer;
    background: rgba(255,255,255,0.1);
    transition: background 0.2s;
  }

  .tab:hover, .tab.active {
    background: white;
    color: #2a3d66;
    font-weight: bold;
  }

  /* Main content */
  .main-content {
    flex: 1;
    padding: 20px;
  }

  .top-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 10px;
  }

  .search-box input {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #ccc;
    width: 260px;
    font-size: 0.8rem;
  }

  .logout-btn {
    background: #c53030;
    color: #fff;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
  }

  .logout-btn:hover {
    background: #9b2c2c;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  th, td {
    padding: 8px 10px;
    border-bottom: 1px solid #e5e7eb;
    text-align: left;
    font-size: 0.8rem;
  }

  th {
    background: #2a3d66;
    color: white;
    text-transform: uppercase;
    font-size: 0.8rem;
  }

  select.status {
    padding: 6px 15px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background: #fff;
    font-weight: 200;
    text-align: center;
  }

  /* Status Colors */
  .status-pending { color: #d97706; font-weight: 500; }
  .status-inprogress { color: #2563eb; font-weight: 500; }
  .status-completed { color: #16a34a; font-weight: 500; }
  .status-replied { color: #7c3aed; font-weight: 500; }

  /* View button */
  .view-btn {
    background: #2a3d66;
    color: white;
    border: none;
    padding: 4px 10px;
    border-radius: 6px;
    cursor: pointer;
  }

  /* Toast */
  .toast {
    visibility: hidden;
    min-width: 220px;
    background-color: #16a34a;
    color: #fff;
    text-align: center;
    border-radius: 8px;
    padding: 12px;
    position: fixed;
    z-index: 9999;
    left: 50%;
    bottom: 30px;
    transform: translateX(-50%);
    font-size: 0.8rem;
    box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    opacity: 0;
    transition: opacity 0.5s, bottom 0.5s;
  }

  .toast.show {
    visibility: visible;
    opacity: 1;
    bottom: 50px;
  }

  /* Popup Modal */
  .modal {
    display: none;
    position: fixed;
    z-index: 10000;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.4);
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }

  .modal-content h3 {
    color: #2a3d66;
    margin-top: 0;
  }

  .close-btn {
    background: #c53030;
    color: white;
    border: none;
    float: right;
    padding: 4px 10px;
    border-radius: 6px;
    cursor: pointer;
  }

  pre {
    white-space: pre-wrap;
    word-wrap: break-word;
  }
</style>
</head>

<!-- Remark Modal -->
<div id="remarkModal" class="modal">
  <div class="modal-content">
    <h3>Update Status Remark</h3>
    <textarea id="remarkInput" placeholder="Write a short remark..." rows="4" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;"></textarea>
    <div style="margin-top:12px;text-align:right;">
      <button id="cancelRemark" class="close-btn" style="background:#6b7280;">Cancel</button>
      <button id="saveRemark" class="close-btn" style="background:#2a3d66;">Save</button>
    </div>
  </div>
</div>

<body>

  <!-- Sidebar Tabs -->
  <div class="sidebar">
    <h2>Online Academy Guru</h2>
    <div class="tab active" data-status="All">üìã All</div>
    <div class="tab" data-status="Pending">üü† Pending</div>
    <div class="tab" data-status="In Progress">üîµ In Progress</div>
    <div class="tab" data-status="Replied">üü£ Replied</div>
    <div class="tab" data-status="Completed">üü¢ Completed</div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="top-bar">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="üîç Search by Name, Email, Mobile, or ID...">
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <table id="requestsTable">
      <thead>
        <tr>
          <th>Request ID</th>
          <th>Role</th>
          <th>Name</th>
          <th>Email</th>
          <th>Mobile</th>
          <th>City & State</th>
          <th>View</th>
          <th>Status</th>
          <th>Submitted</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="toast" class="toast">‚úÖ Status updated!</div>
  </div>

  <!-- Popup Modal -->
  <div id="messageModal" class="modal">
    <div class="modal-content">
      <button class="close-btn" onclick="closeModal()">Close</button>
      <h3>Message Details</h3>
      <pre id="modalMessage"></pre>
    </div>
  </div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx38g7GpXiVyby5LyK8F_xIP3V9aaB8jqV3lI8F9QACIVSWd2RIuaiqvMix5_Egbiue/exec';
const ADMIN_PASSWORD = 'Admin@123';
let allData = [];
let filteredData = [];

// Auth check
(function authenticate() {
  const pass = sessionStorage.getItem("adminAuth") || prompt("Enter admin password:");
  if (pass !== ADMIN_PASSWORD) {
    alert("Access Denied ‚ùå");
    window.location.href = "index.html";
  } else {
    sessionStorage.setItem("adminAuth", ADMIN_PASSWORD);
    loadData();
  }
})();

function logout() {
  sessionStorage.removeItem("adminAuth");
  window.location.href = "index.html";
}

async function loadData() {
  try {
    const res = await fetch(SCRIPT_URL);
    let rawData = await res.json();

    // Normalize keys
    allData = rawData.map(row => {
      const newRow = {};
      for (let key in row) {
        newRow[key.trim()] = row[key];
      }
      return newRow;
    });

    filteredData = allData;
    displayData(allData);
  } catch (err) {
    alert("Failed to load data.");
    console.error(err);
  }
}

// Display Table
function displayData(data) {
  const tbody = document.querySelector("#requestsTable tbody");
  tbody.innerHTML = "";
  data.slice().reverse().forEach(row => {
    const status = row["Status"] || "Pending";
    const cssClass = getStatusClass(status);

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row["Request ID"] || "-"}</td>
      <td>${row["Role"] || "-"}</td>
      <td>${row["Name"] || "-"}</td>
      <td>${row["Email"] || "-"}</td>
      <td>${row["Mobile"] || "-"}</td>
      <td>${row["City & State"] || "-"}</td>
      <td><button class="view-btn">üëÅÔ∏è View</button></td>
      <td>
        <select class="status ${cssClass}" onchange="updateStatus('${row["Request ID"]}', this.value, this)">
          <option ${status==="Pending"?"selected":""}>Pending</option>
          <option ${status==="In Progress"?"selected":""}>In Progress</option>
          <option ${status==="Replied"?"selected":""}>Replied</option>
          <option ${status==="Completed"?"selected":""}>Completed</option>
        </select>
      </td>
      <td>${row["Timestamp"] || "-"}</td>
    `;
    tbody.appendChild(tr);

    // Add View button event listener
    tr.querySelector(".view-btn").addEventListener("click", () => {
      viewMessage(formatMessage(row));
    });
  });
}

function getStatusClass(status) {
  switch(status) {
    case "Pending": return "status-pending";
    case "In Progress": return "status-inprogress";
    case "Completed": return "status-completed";
    case "Replied": return "status-replied";
    default: return "";
  }
}

// Format message for View popup
function formatMessage(row) {
  let msg = `üí¨ Message: ${row["Message"] || "-"}\n\n`;
  msg += `Role: ${row["Role"] || "-"}\n`;
  if(row["Role"] === "Educator") {
    msg += `Class Range: ${row["Class Range (Educator)"] || "-"}\n`;
    msg += `Subject: ${row["Subject (Educator)"] || "-"}\n`;
  } else if(row["Role"] === "Student" || row["Role"] === "Parent/Guardian") {
    msg += `Class Range: ${row["Class Range (SP)"] || "-"}\n`;
    msg += `Class: ${row["Class (SP)"] || "-"}\n`;
    msg += `Subject: ${row["Subject (SP)"] || "-"}\n`;
  }
  msg += `Name: ${row["Name"] || "-"}\n`;
  msg += `Email: ${row["Email"] || "-"}\n`;
  msg += `Mobile: ${row["Mobile"] || "-"}\n`;
  msg += `City & State: ${row["City & State"] || "-"}\n`;
  msg += `Submitted: ${row["Timestamp"] || "-"}\n`;
  msg += `Status: ${row["Status"] || "-"}`;
  return msg;
}

// Modal
function viewMessage(msg) {
  const modal = document.getElementById("messageModal");
  document.getElementById("modalMessage").innerText = msg;
  modal.style.display = "flex";
}
function closeModal() {
  document.getElementById("messageModal").style.display = "none";
}

// Status update
async function updateStatus(requestId, newStatus, selectElement) {
  const oldStatus = selectElement.dataset.oldStatus || selectElement.value;
  const remark = prompt(`Enter remark for changing status to "${newStatus}":`);
  if (!remark) {
    selectElement.value = oldStatus;
    return;
  }

  selectElement.className = "status " + getStatusClass(newStatus);

  try {
    await fetch(`${SCRIPT_URL}?update=${encodeURIComponent(requestId)}&status=${encodeURIComponent(newStatus)}&remark=${encodeURIComponent(remark)}`);
    showToast("‚úÖ Status updated to " + newStatus);
    selectElement.dataset.oldStatus = newStatus;
  } catch {
    selectElement.value = oldStatus;
    showToast("‚ùå Error updating status");
  }
}

// Toast
function showToast(message) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 2500);
}

// Sidebar filter
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", function() {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    this.classList.add("active");
    const status = this.dataset.status;
    filteredData = (status==="All") ? allData : allData.filter(r => (r["Status"] || "Pending") === status);
    displayData(filteredData);
  });
});

// Fuzzy Search
function fuzzyMatch(query, text) {
  query = query.toLowerCase();
  text = text.toLowerCase();
  return text.includes(query);
}

document.getElementById("searchInput").addEventListener("keyup", function() {
  const query = this.value.toLowerCase().trim();
  if (!query) return displayData(filteredData);
  const result = filteredData.filter(row =>
    fuzzyMatch(query, row["Name"] || "") ||
    fuzzyMatch(query, row["Email"] || "") ||
    fuzzyMatch(query, row["Mobile"] || "") ||
    fuzzyMatch(query, row["Request ID"] || "")
  );
  displayData(result);
});
</script>
</body>
</html>

